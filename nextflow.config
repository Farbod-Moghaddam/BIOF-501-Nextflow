/*
========================================================================================
    Nextflow Configuration File
========================================================================================
*/

params {
    // Input/Output
    input               = "${projectDir}/input_downsampled.csv"
    outdir              = "${projectDir}/results"

    // Reference files (UPDATE THESE PATHS)
    transcriptome       = "${projectDir}/reference/Homo_sapiens.GRCh38.cdna.all.fa.gz"
    gtf                 = "${projectDir}/reference/Homo_sapiens.GRCh38.110.gtf"
    tx2gene             = null
    kallisto_index      = null

    // Kallisto parameters
    bootstrap_samples   = 30

    // Read parameters
    min_quality         = 20
    min_length          = 36

    // Resource limits
    max_cpus            = 16
    max_memory          = '64.GB'
    max_time            = '48.h'
}

// Process configuration
process {
    // SLURM executor settings
    executor = 'slurm'
    
    cpus   = 16
    memory = '32.GB'
    time   = '8.h'
    
    // SLURM-specific options
    clusterOptions = '--qos=normal'

    // Error handling
    errorStrategy = 'retry'
    maxRetries    = 2
    
    // Allow multiple FastQC, TRIM_READS, and KALLISTO_QUANT jobs to run in parallel
    withName: 'FASTQC|TRIM_READS|KALLISTO_QUANT' {
        maxForks = 10  // Submit up to 10 jobs at once
    }
}

// Executor configuration - Use SLURM for parallel job submission
executor {
    name = 'slurm'
    queueSize = 50  // Maximum number of jobs to submit at once
    submitRateLimit = '10 sec'  // Submit up to 10 jobs per second
}

// Singularity configuration
singularity {
    enabled = true
    autoMounts = true
    cacheDir = "$HOME/.singularity/cache"
}

// Report and trace options
timeline {
    enabled = true
    file = "${params.outdir}/pipeline_info/timeline.html"
    overwrite = true
}

report {
    enabled = true
    file = "${params.outdir}/pipeline_info/report.html"
    overwrite = true
}

trace {
    enabled = true
    file = "${params.outdir}/pipeline_info/trace.txt"
    overwrite = true
}

dag {
    enabled = true
    file = "${params.outdir}/pipeline_info/dag.html"
    overwrite = true
}

// Manifest
manifest {
    name            = 'RNA-seq Analysis Pipeline'
    author          = 'Your Name'
    homePage        = 'https://github.com/Farbod-Moghaddam/BIOF-501-Nextflow'
    description     = 'Nextflow pipeline for RNA-seq quality control, trimming, rRNA removal, alignment, and feature counting'
    mainScript      = 'main.nf'
    nextflowVersion = '>=21.04.0'
    version         = '1.0.0'
}

// Function to ensure output directory exists
def check_max(obj, type) {
    if (type == 'memory') {
        try {
            if (obj.compareTo(params.max_memory as nextflow.util.MemoryUnit) == 1)
                return params.max_memory as nextflow.util.MemoryUnit
            else
                return obj
        } catch (all) {
            println "ERROR: invalid max memory '${params.max_memory}'"
            return obj
        }
    } else if (type == 'time') {
        try {
            if (obj.compareTo(params.max_time as nextflow.util.Duration) == 1)
                return params.max_time as nextflow.util.Duration
            else
                return obj
        } catch (all) {
            println "ERROR: invalid max time '${params.max_time}'"
            return obj
        }
    } else if (type == 'cpus') {
        try {
            return Math.min(obj, params.max_cpus as int)
        } catch (all) {
            println "ERROR: invalid max cpus '${params.max_cpus}'"
            return obj
        }
    }
}
